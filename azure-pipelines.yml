trigger:
  branches:
    include:
      - main
      - dev
      - feature/*

variables:
  buildConfiguration: 'Release'
  solution: 'EventDrivenMicroservicesSolution.sln'
  runSettingsFile: 'coverlet.runsettings'
  coverageDirectory: '$(Build.SourcesDirectory)/TestResults'
  dotnetVersion: '9.x'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: Build
        displayName: 'Build Solution'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet packages'
            inputs:
              command: 'restore'
              projects: '$(solution)'

          - task: DotNetCoreCLI@2
            displayName: 'Build Solution'
            inputs:
              command: 'build'
              projects: '$(solution)'
              arguments: '--configuration $(buildConfiguration)'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Build Output'
            inputs:
              targetPath: '$(Build.SourcesDirectory)'
              artifact: 'build-output'

  - stage: TestAndAnalyze
    displayName: 'Run Tests and Code Analysis'
    dependsOn: Build
    jobs:
      - job: Test
        displayName: 'Run Tests and Generate Coverage'
        pool:
          vmImage: 'windows-latest'
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Output'
            inputs:
              artifact: 'build-output'
              path: '$(Build.SourcesDirectory)'

          - task: UseDotNet@2
            displayName: 'Use .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'

          - task: SonarCloudPrepare@3
            displayName: 'Prepare SonarCloud Analysis'
            inputs:
              SonarCloud: 'SonarCloud'
              organization: '$(SONAR_ORGANIZATION)'
              scannerMode: 'dotnet'
              projectKey: '$(SONAR_PROJECT_KEY)'
              projectName: 'EventDrivenMicroservicesSolution'
              extraProperties: |
                sonar.exclusions=**/bin/**,**/obj/**
                sonar.cs.opencover.reportsPaths=$(coverageDirectory)/**/*.opencover.xml

          - task: DotNetCoreCLI@2
            displayName: 'Run All Tests with Coverage'
            inputs:
              command: 'test'
              projects: '**/tests/**/*.csproj'
              arguments: >
                --configuration $(buildConfiguration)
                --no-build
                --collect:"XPlat Code Coverage"
                --settings $(Build.SourcesDirectory)/$(runSettingsFile)
              publishTestResults: true
              resultsDirectory: '$(coverageDirectory)'

          - script: |
              echo "Verifying generated test coverage files..."
              dir "$(coverageDirectory)" /s /b
            displayName: 'Debug: List Coverage Files'
            continueOnError: true

          - task: ReportGenerator@5
            displayName: 'Generate Coverage Report'
            inputs:
              reports: '$(coverageDirectory)/**/coverage.cobertura.xml'
              targetdir: '$(Build.ArtifactStagingDirectory)/CoverageReport'
              reporttypes: 'HtmlInline_AzurePipelines;Cobertura'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish Code Coverage to Azure DevOps'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(Build.ArtifactStagingDirectory)/CoverageReport/Cobertura.xml'

          - task: SonarCloudAnalyze@3
            displayName: 'Run SonarCloud Analysis'

          - task: SonarCloudPublish@3
            displayName: 'Publish SonarCloud Results'
            inputs:
              pollingTimeoutSec: '300'
